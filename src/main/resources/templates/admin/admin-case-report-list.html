<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>CARS - Child Abuse Reporting System</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />

    <!-- Fonts and icons -->
    <script src="../assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
        WebFont.load({
            google: { families: ["Public Sans:300,400,500,600,700"] },
            custom: {
                families: [
                    "Font Awesome 5 Solid",
                    "Font Awesome 5 Regular",
                    "Font Awesome 5 Brands",
                    "simple-line-icons",
                ],
                urls: ["../static/assets/css/fonts.min.css"],
            },
            active: function () {
                sessionStorage.fonts = true;
            },
        });
    </script>
    <link th:href="@{/assets/css/bootstrap.min.css}" rel="stylesheet" />
    <link th:href="@{/assets/css/plugins.min.css}" rel="stylesheet" />
    <link th:href="@{/assets/css/kaiadmin.min.css}" rel="stylesheet" />
    <link th:href="@{/assets/css/sidebar-override.css}" rel="stylesheet" />
    <link th:href="@{/assets/css/navbar-override.css}" rel="stylesheet" />
    <script src="../../static/assets/js/sidebar.js"></script>
    <link th:href="@{/assets/css/public-footer.css}" rel="stylesheet" />

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


    <style>
        .action-buttons .btn {
            padding: 6px 12px;
            margin: 0 3px;
        }
        .action-buttons .btn i {
            font-size: 14px;
        }
        .add-report-button {
            margin-right: auto !important;
        }
        .report-dropdown {
            position: relative;
            display: inline-block;
        }
        .report-dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
        }
        .report-dropdown-content a {
            color: black;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }
        .report-dropdown-content a:hover {
            background-color: #f1f1f1;
            border-radius: 4px;
        }
        .report-dropdown:hover .report-dropdown-content {
            display: block;
        }
        .report-tools {
            margin-left: 10px;
            display: flex;
            justify-content: flex-end;
            align-items: flex-start;
            gap: 10px;
        }
        .report-tools .btn {
            margin: 0 5px;
        }
        .case-report-dropdown {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10;
            border-radius: 4px;
            padding: 5px 0;
        }
        .case-report-dropdown a {
            color: black;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }
        .case-report-dropdown a:hover {
            background-color: #f1f1f1;
        }
        #print-section {
            display: none;
        }
        @media print {
            #print-section {
                display: block;
            }
            body * {
                visibility: hidden;
            }
            #print-section, #print-section * {
                visibility: visible;
            }
            #print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
        .badge-abuse-type {
            padding: 5px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .badge-physical {
            background-color: #f5365c;
            color: white;
        }
        .badge-emotional {
            background-color: #fb6340;
            color: white;
        }
        .badge-sexual {
            background-color: #8965e0;
            color: white;
        }
        .badge-neglect {
            background-color: #f7b924;
            color: white;
        }
        .badge-other {
            background-color: #adb5bd;
            color: white;
        }
        .table-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-open {
            background-color: #2dce89;
        }
        .status-investigating {
            background-color: #11cdef;
        }
        .status-closed {
            background-color: #8898aa;
        }
        .status-urgent {
            background-color: #f5365c;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>
    <div class="main-panel">
        <div th:replace="~{fragments/navbar :: navbar}"></div>

        <div class="container">
            <div class="page-inner">
                <div class="page-header">
                    <h3 class="fw-bold mb-3">Case Reports</h3>
                    <ul class="breadcrumbs mb-3">
                        <li class="nav-home">
                            <a href="#">
                                <i class="icon-home"></i>
                            </a>
                        </li>
                        <li class="separator">
                            <i class="icon-arrow-right"></i>
                        </li>
                        <li class="nav-item">
                            <a href="#">Reports</a>
                        </li>
                        <li class="separator">
                            <i class="icon-arrow-right"></i>
                        </li>
                        <li class="nav-item">
                            <a href="#">Case Reports</a>
                        </li>
                    </ul>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex align-items-center">
                                    <h4 class="card-title">All Case Reports</h4>
                                    <!-- Report Generation Tools -->
                                    <div class="report-tools">
                                        <div class="report-dropdown">
                                            <button class="btn btn-success btn-round">
                                                <i class="fa fa-file-export mr-2"></i>
                                                Export All
                                            </button>
                                            <div class="report-dropdown-content">
                                                <a href="#" onclick="downloadFilteredCasesReport('PDF'); return false;">
                                                    <i class="fas fa-file-pdf mr-2"></i>PDF
                                                </a>
                                                <a href="#" onclick="downloadFilteredCasesReport('CSV'); return false;">
                                                    <i class="fas fa-file-csv mr-2"></i>CSV
                                                </a>
                                                <a href="#" onclick="downloadFilteredCasesReport('EXCEL'); return false;">
                                                    <i class="fas fa-file-excel mr-2"></i>Excel
                                                </a>
                                            </div>
                                        </div>
                                        <button class="btn btn-info btn-round" onclick="printTable()">
                                            <i class="fa fa-print mr-2"></i>
                                            Print
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="caseTable" class="display table table-striped table-hover">
                                        <thead>
                                        <tr>
                                            <th>No.</th>
                                            <th>Case ID</th>
                                            <th>Child Name</th>
                                            <th>Abuse Type</th>
                                            <th>Status</th>
                                            <th>Location</th>
                                            <th>Date Reported</th>
                                            <th style="width: 15%">Actions</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="report : ${caseReports}">
                                            <td></td>
                                            <td th:text="${report.caseId}">CASE-2023-001</td>
                                            <td th:text="${report.childFullName}">John Doe</td>
                                            <td>
                                                <span th:class="${'badge badge-abuse-type badge-' + #strings.toLowerCase(report.abuseType)}"
                                                      th:text="${report.abuseType}">Physical</span>
                                            </td>
                                            <td>
                                                <span th:class="${'table-status status-' + #strings.toLowerCase(report.status)}"></span>
                                                <span th:text="${report.status}">Open</span>
                                            </td>
                                            <td th:text="${report.locationOfIncident}">123 Main St</td>
                                            <td th:text="${#temporals.format(report.reportDate, 'yyyy-MM-dd HH:mm')}">2023-05-15 14:30</td>
                                            <td class="action-buttons">
                                                <!-- Button group to align buttons horizontally -->
                                                <div class="btn-group" role="group" aria-label="Action buttons">
                                                    <!-- View Button -->
                                                    <a class="btn btn-primary btn-sm" th:href="@{/api/v1/admin/view/{id}(id=${report.id})}" title="View">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <!-- Assign to Authorities Button (Replaced Edit Button) -->
                                                    <a class="btn btn-warning btn-sm" th:href="@{/api/v1/case-reports/assign/{id}(id=${report.id})}" title="Assign to Authorities">
                                                        <i class="fas fa-user-shield"></i>
                                                    </a>
                                                    <!-- Delete Button -->
                                                    <a class="btn btn-danger btn-sm" th:href="@{/api/v1/admin/delete/{id}(id=${report.id})}"
                                                       th:attr="onclick='return confirmDelete(event, this.href)'" title="Delete">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div th:replace="~{fragments/public-footer :: public-footer}"></div>
    </div>
</div>

<!-- Assignment Modal -->
<div class="modal fade" id="assignAuthorityModal" tabindex="-1" role="dialog" aria-labelledby="assignModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignModalLabel">Assign Case to Authorities</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="assignForm" method="post">
                    <input type="hidden" id="caseId" name="caseId">

                    <!-- Case Details Section -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="m-0">Case Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Case ID:</strong> <span id="viewCaseId"></span></p>
                                    <p><strong>Child Name:</strong> <span id="viewChildName"></span></p>
                                    <p><strong>Abuse Type:</strong> <span id="viewAbuseType"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Status:</strong> <span id="viewStatus"></span></p>
                                    <p><strong>Location:</strong> <span id="viewLocation"></span></p>
                                    <p><strong>Date Reported:</strong> <span id="viewDateReported"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Authority Assignment Section -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="m-0">Authority Assignment</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="authorityRole">Authority Role</label>
                                <select id="authorityRole" name="authorityRole" class="form-control" required>
                                    <option value="">-- Select Role --</option>
                                    <option value="ADMIN">Admin</option>
                                    <option value="SOCIAL_WORKER">Social Worker</option>
                                    <option value="POLICE_OFFICER">Police Officer</option>
                                    <option value="HEALTHCARE">Healthcare</option>
                                    <option value="PUBLIC">Public</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="priorityLevel">Priority Level</label>
                                <select id="priorityLevel" name="priorityLevel" class="form-control" required>
                                    <option value="">-- Select Priority --</option>
                                    <option value="HIGH">High</option>
                                    <option value="MEDIUM">Medium</option>
                                    <option value="LOW">Low</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="assignmentNotes">Assignment Notes</label>
                                <textarea class="form-control" id="assignmentNotes" name="assignmentNotes" rows="3"
                                          placeholder="Enter any specific instructions or context for this assignment"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="confirmAssignBtn">Confirm Assignment</button>
            </div>
            <!-- Display selected values for debugging -->
            <div class="selected-values-display">
                <strong>Selected Authority Roles:</strong>
                <div id="selectedValuesDisplay">[]</div>
            </div>
        </div>
    </div>
</div>

<!-- Print Section (Hidden) -->
<div id="print-section">
    <div style="padding: 20px;">
        <h2 style="text-align: center;">Case Reports</h2>
        <p style="text-align: right; font-size: 12px;">Generated on: <span id="print-date"></span></p>
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Case ID</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Child Name</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Reporter</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Abuse Type</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Status</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Location</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Date Reported</th>
            </tr>
            </thead>
            <tbody id="print-tbody">
            <!-- Will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!--   Core JS Files   -->
<script src="../../static/assets/js/core/jquery-3.7.1.min.js"></script>
<script src="../../static/assets/js/core/popper.min.js"></script>
<script src="../../static/assets/js/core/bootstrap.min.js"></script>

<!-- jQuery Scrollbar -->
<script src="../../static/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
<!-- Kaiadmin JS -->
<script src="../../static/assets/js/kaiadmin.min.js"></script>
<!-- Kaiadmin DEMO methods, don't include it in your project! -->
<script src="../../static/assets/js/setting-demo2.js"></script>

<!-- SweetAlert2 CSS (optional, for default styling) -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Include DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">

<!-- Include jQuery and DataTables JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<!-- JavaScript for handling the assignment functionality -->
<script>
    class MultiSelectDropdown {
        constructor(containerId, options = {}) {
            this.container = document.getElementById(containerId);
            this.dropdown = this.container.querySelector('.multi-select-dropdown');
            this.optionsContainer = this.container.querySelector('.multi-select-options');
            this.options = this.container.querySelectorAll('.multi-select-option');
            this.selectedValues = [];
            this.placeholder = options.placeholder || '-- Select Options --';
            this.required = options.required || false;
            this.name = options.name || 'multiselect';

            this.init();
        }

        init() {
            // Bind events
            this.dropdown.addEventListener('click', (e) => {
                e.stopPropagation();
                this.toggle();
            });

            this.options.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.selectOption(option);
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                this.close();
            });

            // Create hidden input for form submission
            this.createHiddenInput();
        }

        createHiddenInput() {
            this.hiddenInput = document.createElement('input');
            this.hiddenInput.type = 'hidden';
            this.hiddenInput.name = this.name;
            this.hiddenInput.id = this.name;
            this.container.appendChild(this.hiddenInput);
        }

        toggle() {
            if (this.optionsContainer.classList.contains('show')) {
                this.close();
            } else {
                this.open();
            }
        }

        open() {
            this.optionsContainer.classList.add('show');
            this.dropdown.classList.add('open');
        }

        close() {
            this.optionsContainer.classList.remove('show');
            this.dropdown.classList.remove('open');
        }

        selectOption(option) {
            const value = option.dataset.value;
            const checkIcon = option.querySelector('.check-icon');

            if (this.selectedValues.includes(value)) {
                // Deselect
                this.selectedValues = this.selectedValues.filter(v => v !== value);
                option.classList.remove('selected');
                checkIcon.style.display = 'none';
            } else {
                // Select
                this.selectedValues.push(value);
                option.classList.add('selected');
                checkIcon.style.display = 'inline';
            }

            this.updateDisplay();
            this.updateHiddenInput();
            this.validateSelection();
            this.triggerChange();
        }

        updateDisplay() {
            // Clear current display
            this.dropdown.innerHTML = '';

            if (this.selectedValues.length === 0) {
                const placeholder = document.createElement('span');
                placeholder.className = 'multi-select-placeholder';
                placeholder.textContent = this.placeholder;
                this.dropdown.appendChild(placeholder);
            } else {
                this.selectedValues.forEach(value => {
                    const option = this.container.querySelector(`[data-value="${value}"]`);
                    const optionText = option.querySelector('span').textContent.trim();

                    const tag = document.createElement('span');
                    tag.className = 'selected-tag';
                    tag.innerHTML = `
                            ${optionText}
                            <i class="fas fa-times remove-tag" data-value="${value}"></i>
                        `;

                    // Add remove functionality
                    const removeBtn = tag.querySelector('.remove-tag');
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.removeTag(value);
                    });

                    this.dropdown.appendChild(tag);
                });
            }
        }

        removeTag(value) {
            this.selectedValues = this.selectedValues.filter(v => v !== value);
            const option = this.container.querySelector(`[data-value="${value}"]`);
            option.classList.remove('selected');
            option.querySelector('.check-icon').style.display = 'none';

            this.updateDisplay();
            this.updateHiddenInput();
            this.validateSelection();
            this.triggerChange();
        }

        updateHiddenInput() {
            this.hiddenInput.value = JSON.stringify(this.selectedValues);
        }

        validateSelection() {
            const errorElement = document.getElementById('authorityRoleError');

            if (this.required && this.selectedValues.length === 0) {
                this.dropdown.classList.add('is-invalid');
                this.dropdown.classList.remove('is-valid');
                errorElement.style.display = 'block';
                return false;
            } else {
                this.dropdown.classList.remove('is-invalid');
                this.dropdown.classList.add('is-valid');
                errorElement.style.display = 'none';
                return true;
            }
        }

        triggerChange() {
            // Trigger change event for integration with existing code
            const event = new CustomEvent('multiSelectChange', {
                detail: {
                    selectedValues: this.selectedValues,
                    isValid: this.validateSelection()
                }
            });
            this.container.dispatchEvent(event);
        }

        getSelectedValues() {
            return this.selectedValues;
        }

        setSelectedValues(values) {
            // Clear current selection
            this.selectedValues = [];
            this.options.forEach(option => {
                option.classList.remove('selected');
                option.querySelector('.check-icon').style.display = 'none';
            });

            // Set new selection
            values.forEach(value => {
                if (!this.selectedValues.includes(value)) {
                    const option = this.container.querySelector(`[data-value="${value}"]`);
                    if (option) {
                        this.selectedValues.push(value);
                        option.classList.add('selected');
                        option.querySelector('.check-icon').style.display = 'inline';
                    }
                }
            });

            this.updateDisplay();
            this.updateHiddenInput();
            this.validateSelection();
        }

        reset() {
            this.setSelectedValues([]);
        }
    }

    // Initialize the multi-select dropdown
    const authorityRoleSelector = new MultiSelectDropdown('authorityRoleDropdown'.replace('Dropdown', 'Container'), {
        placeholder: '-- Select Roles --',
        required: true,
        name: 'authorityRole'
    });

    // Update the container ID reference
    const container = document.querySelector('.multi-select-container');
    container.id = 'authorityRoleContainer';

    // Re-initialize with correct ID
    const authoritySelector = new MultiSelectDropdown('authorityRoleContainer', {
        placeholder: '-- Select Roles --',
        required: true,
        name: 'authorityRole'
    });

    // Integration with existing form validation
    container.addEventListener('multiSelectChange', function(e) {
        const selectedValues = e.detail.selectedValues;
        const isValid = e.detail.isValid;

        // Update display for debugging
        document.getElementById('selectedValuesDisplay').textContent = JSON.stringify(selectedValues);

        // Enable/disable confirm button based on validation
        const priorityLevel = document.getElementById('priorityLevel').value;
        const confirmBtn = document.getElementById('confirmAssignBtn');

        confirmBtn.disabled = !(isValid && priorityLevel);
    });

    // Handle priority level changes
    document.getElementById('priorityLevel').addEventListener('change', function() {
        const priorityLevel = this.value;
        const isAuthorityValid = authoritySelector.getSelectedValues().length > 0;
        const confirmBtn = document.getElementById('confirmAssignBtn');

        confirmBtn.disabled = !(isAuthorityValid && priorityLevel);
    });

    // Modified confirmation handler to work with multi-select
    document.getElementById('confirmAssignBtn').addEventListener('click', function() {
        const selectedRoles = authoritySelector.getSelectedValues();
        const priorityLevel = document.getElementById('priorityLevel').value;
        const assignmentNotes = document.getElementById('assignmentNotes').value;

        // Validate
        if (selectedRoles.length === 0) {
            alert('Please select at least one authority role');
            return;
        }

        if (!priorityLevel) {
            alert('Please select a priority level');
            return;
        }

        // Form data for backend
        const formData = {
            caseId: parseInt(document.getElementById('caseId')?.value || 1), // Mock case ID
            authorityRoles: selectedRoles, // Array of selected roles
            assignmentNotes: assignmentNotes,
            priorityLevel: priorityLevel
        };

        console.log('Form data to send to backend:', formData);

        // Show loading state
        const originalText = this.textContent;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Assigning...';
        this.disabled = true;

        // Simulate API call (replace with your actual endpoint)
        setTimeout(() => {
            // Mock successful response
            const mockResponse = {
                id: 'ASN-' + Date.now(),
                caseId: formData.caseId,
                authorityRoles: formData.authorityRoles,
                priorityLevel: formData.priorityLevel,
                assignedAt: new Date().toISOString(),
                status: 'SUCCESS'
            };

            console.log('Mock API Response:', mockResponse);

            // Show success message
            alert(`Assignment Successful!\nRoles: ${selectedRoles.join(', ')}\nPriority: ${priorityLevel}`);

            // Reset form
            authoritySelector.reset();
            document.getElementById('priorityLevel').value = '';
            document.getElementById('assignmentNotes').value = '';

            // Reset button
            this.innerHTML = '<i class="fas fa-check me-2"></i>Confirm Assignment';
            this.disabled = true;
        }, 2000);
    });

    // Form reset functionality
    function resetAssignmentForm() {
        authoritySelector.reset();
        document.getElementById('priorityLevel').value = '';
        document.getElementById('assignmentNotes').value = '';
        document.getElementById('confirmAssignBtn').disabled = true;
    }
</script>

<script>
    // Function to show a designed success alert
    function showSuccessAlert(response, formData) {
        console.log('Response data:', response); // Debug log

        // Extract data safely with fallbacks
        const assignmentId = response.id || response.assignmentId || 'N/A';
        const authorityRole = response.authorityRole || formData.authorityRole || 'N/A';
        const priorityLevel = response.priorityLevel || formData.priorityLevel || 'N/A';
        const assignedAt = response.assignedAt || response.createdAt || response.timestamp || new Date().toISOString();
        const caseId = response.caseId || formData.caseId || 'N/A';

        // Create a custom success alert
        const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show position-fixed"
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"
                 role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2" style="font-size: 1.2em; color: #155724;"></i>
                    <div>
                        <h6 class="alert-heading mb-1">Case Successfully Assigned!</h6>
                        <small class="mb-0">
                            <strong>Case ID:</strong> ${caseId}<br>
                            <strong>Authority:</strong> ${authorityRole}<br>
                            <strong>Priority:</strong> ${priorityLevel}<br>
                            <strong>Assigned:</strong> ${new Date(assignedAt).toLocaleString()}
                        </small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;

        // Remove any existing alerts
        $('.alert.position-fixed').remove();

        // Add the new alert to the body
        $('body').append(alertHtml);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            $('.alert.position-fixed').fadeOut(500, function() {
                $(this).remove();
            });
        }, 5000);
    }

    // Function to redirect to home with success message
    function redirectToHome(response, formData) {
        console.log('Response data for redirect:', response); // Debug log

        // Extract data safely with fallbacks
        const assignmentId = response.id || response.assignmentId || 'N/A';
        const authorityRole = response.authorityRole || formData.authorityRole || 'N/A';
        const priorityLevel = response.priorityLevel || formData.priorityLevel || 'N/A';
        const assignedAt = response.assignedAt || response.createdAt || response.timestamp || new Date().toISOString();
        const caseId = response.caseId || formData.caseId || 'N/A';

        // Store success message in sessionStorage for display on home page
        const successData = {
            message: 'Case Successfully Assigned!',
            caseId: caseId,
            assignmentId: assignmentId,
            authorityRole: authorityRole,
            priorityLevel: priorityLevel,
            assignedAt: assignedAt
        };

        sessionStorage.setItem('assignmentSuccess', JSON.stringify(successData));

        // Redirect to home page
        window.location.href = '/'; // Change this to your home page URL
    }

    // Function to open the assignment modal
    function openAssignModal(caseId) {
        // Clear previous form data
        $("#assignForm")[0].reset();

        // Set the case ID in the hidden field
        $("#caseId").val(caseId);

        // Fetch case details and populate the view
        $.ajax({
            url: `/api/v1/case-reports/${caseId}`,
            type: 'GET',
            success: function(data) {
                // Populate case details in the modal
                $("#viewCaseId").text(data.caseId);
                $("#viewChildName").text(data.childFullName);
                $("#viewAbuseType").text(data.abuseType);
                $("#viewStatus").text(data.status);
                $("#viewLocation").text(data.locationOfIncident);
                $("#viewDateReported").text(data.reportDate);

                // Show the modal
                $('#assignAuthorityModal').modal('show');
            },
            error: function(xhr, status, error) {
                console.error('Error fetching case details:', error);
                alert('Error fetching case details. Please try again.');
            }
        });
    }

    // Handle assign button clicks from the table
    $(document).on('click', 'a[href^="/api/v1/case-reports/assign/"]', function(e) {
        e.preventDefault();
        const href = $(this).attr('href');
        const caseId = href.substring(href.lastIndexOf('/') + 1);
        openAssignModal(caseId);
    });

    // Handle confirmation of assignment
    $("#confirmAssignBtn").click(function() {
        // Validate the form
        const form = $("#assignForm")[0];
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // Get form data
        const formData = {
            caseId: parseInt($("#caseId").val()),
            authorityRole: $("#authorityRole").val(),
            assignmentNotes: $("#assignmentNotes").val(),
            priorityLevel: $("#priorityLevel").val()
        };

        // Validate required fields
        if (!formData.caseId || !formData.authorityRole || !formData.priorityLevel) {
            alert('Please fill in all required fields (Authority Role and Priority Level)');
            return;
        }

        // Show loading state
        const originalText = $("#confirmAssignBtn").text();
        $("#confirmAssignBtn").text('Assigning...').prop('disabled', true);

        // Submit assignment to your service endpoint
        $.ajax({
            url: '/api/v1/case-reports/assign',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                console.log('Assignment successful:', response);

                // Close modal
                $('#assignAuthorityModal').modal('hide');

                // CHOOSE ONE OF THE OPTIONS BELOW:

                // Option 1: Show designed alert and stay on current page
                showSuccessAlert(response, formData);
            },
            error: function(xhr, status, error) {
                console.error('Error assigning case:', {
                    status: xhr.status,
                    responseText: xhr.responseText,
                    error: error
                });

                let errorMessage = 'Error assigning case: ';

                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage += xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    errorMessage += xhr.responseText;
                } else {
                    errorMessage += 'Unknown error occurred';
                }

                // Show error alert
                const errorAlertHtml = `
                    <div class="alert alert-danger alert-dismissible fade show position-fixed"
                         style="top: 20px; right: 20px; z-index: 9999; min-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"
                         role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-2" style="font-size: 1.2em; color: #721c24;"></i>
                            <div>
                                <h6 class="alert-heading mb-1">Assignment Failed</h6>
                                <small class="mb-0">${errorMessage}</small>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;

                $('.alert.position-fixed').remove();
                $('body').append(errorAlertHtml);

                setTimeout(() => {
                    $('.alert.position-fixed').fadeOut(500, function() {
                        $(this).remove();
                    });
                }, 5000);
            },
            complete: function() {
                // Reset button state
                $("#confirmAssignBtn").text(originalText).prop('disabled', false);
            }
        });
    });

    // Function to check and display success message on page load (for home page redirect option)
    function checkForSuccessMessage() {
        const successData = sessionStorage.getItem('assignmentSuccess');
        if (successData) {
            const data = JSON.parse(successData);

            // Show success message
            const welcomeAlertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-3" style="font-size: 1.5em;"></i>
                        <div>
                            <h5 class="alert-heading mb-2">${data.message}</h5>
                            <p class="mb-0">
                                <strong>Case ID:</strong> ${data.caseId}<br>
                                <strong>Assignment ID:</strong> ${data.assignmentId}<br>
                                <strong>Authority:</strong> ${data.authorityRole}<br>
                                <strong>Priority:</strong> ${data.priorityLevel}<br>
                                <strong>Assigned:</strong> ${new Date(data.assignedAt).toLocaleString()}
                            </p>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            // Add to the top of main content area (adjust selector as needed)
            $('.container-fluid, .container, main, #main-content').first().prepend(welcomeAlertHtml);

            // Clear the session storage
            sessionStorage.removeItem('assignmentSuccess');

            // Auto-dismiss after 7 seconds
            setTimeout(() => {
                $('.alert-success').fadeOut(500, function() {
                    $(this).remove();
                });
            }, 7000);
        }
    }

    // Optional: Add real-time validation
    $("#authorityRole, #priorityLevel").change(function() {
        const authorityRole = $("#authorityRole").val();
        const priorityLevel = $("#priorityLevel").val();

        // Enable/disable confirm button based on required fields
        const isValid = authorityRole && priorityLevel;
        $("#confirmAssignBtn").prop('disabled', !isValid);
    });

    // Optional: Handle modal close events to reset form
    $('#assignAuthorityModal').on('hidden.bs.modal', function () {
        $("#assignForm")[0].reset();
        $("#confirmAssignBtn").prop('disabled', false).text('Confirm Assignment');
    });

    // Initialize success message check on page load (for home page redirect option)
    $(document).ready(function() {
        checkForSuccessMessage();
    });
</script>

<script th:inline="none">
    $(document).ready(function() {
        $('#caseTable').DataTable({
            "paging": true,       // Enables pagination
            "searching": true,    // Enables search box
            "ordering": true,     // Enables column sorting
            "info": true,         // Shows info about records
            "lengthMenu": [5, 10, 25, 50], // Dropdown for entries
            "pageLength": 10,     // Default entries per page
            "order": [[7, "desc"]], // Sort by Date Reported (now column 7) in descending order
            "columnDefs": [
                { "type": "date", "targets": 7 }, // Specify that column 7 contains date data
                {
                    "targets": 0,
                    "searchable": false,
                    "orderable": false,
                    "className": "text-center"
                }
            ],
            "drawCallback": function(settings) {
                // Update row numbers on each draw (page change, filter, sort, etc.)
                this.api().column(0).nodes().each(function(cell, i) {
                    // Calculate row number based on pagination
                    var info = $('#caseTable').DataTable().page.info();
                    var index = (info.page * info.length) + (i + 1);
                    cell.innerHTML = index;
                });
            }
        });
    });
</script>
<script>
    function confirmDelete(event, deleteUrl) {
        event.preventDefault(); // Prevent default navigation

        Swal.fire({
            title: 'Are you sure?',
            text: "This action cannot be undone.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'No, cancel',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire(
                    'Deleted!',
                    'The case report has been deleted.',
                    'success'
                );
                // Redirect to delete URL after confirmation
                if (deleteUrl) {
                    window.location.href = deleteUrl;
                }
            }
        });
    }

    // Function to download report for filtered/sorted cases
    function downloadFilteredCasesReport(format) {
        // Get current DataTable state
        var table = $('#caseTable').DataTable();
        var searchValue = table.search();
        var orderColumn = table.order()[0] ? table.order()[0][0] : null;
        var orderDirection = table.order()[0] ? table.order()[0][1] : null;

        // Base URL from your controller
        var baseUrl = '/api/v1/reports/export';

        // Choose endpoint based on format
        var endpoint;
        switch(format) {
            case 'PDF': endpoint = baseUrl + '/pdf'; break;
            case 'CSV': endpoint = baseUrl + '/csv'; break;
            case 'EXCEL': endpoint = baseUrl + '/excel'; break;
            default: endpoint = baseUrl + '/pdf';
        }

        // Add query parameters for filtering and sorting
        var queryParams = [];
        if (searchValue) {
            queryParams.push('search=' + encodeURIComponent(searchValue));
        }
        if (orderColumn !== null && orderDirection) {
            queryParams.push('orderColumn=' + orderColumn);
            queryParams.push('orderDirection=' + orderDirection);
        }

        // Construct final URL
        var url = endpoint;
        if (queryParams.length > 0) {
            url += '?' + queryParams.join('&');
        }

        // Redirect to the report URL
        window.location.href = url;
    }

    // Function to download report for a single case
    function downloadSingleCaseReport(format, caseId) {
        if (!caseId) {
            console.error('Case ID is missing');
            return false;
        }

        // Base URL from your controller
        var baseUrl = '/api/v1/reports/export';

        // Choose endpoint based on format and case ID
        var url;
        switch(format) {
            case 'PDF': url = baseUrl + '/pdf/' + caseId; break;
            case 'CSV': url = baseUrl + '/csv/' + caseId; break;
            case 'EXCEL': url = baseUrl + '/excel/' + caseId; break;
            default: url = baseUrl + '/pdf/' + caseId;
        }

        // Redirect to the report URL
        window.location.href = url;
        return false;
    }

    // Function to print the table
    function printTable() {
        // Copy the table data to the print section
        var printTbody = document.getElementById('print-tbody');
        printTbody.innerHTML = '';

        // Get the current visible rows from DataTable
        var tableRows = $('#caseTable').DataTable().rows({search:'applied'}).nodes();

        // For each row in the table
        for (var i = 0; i < tableRows.length; i++) {
            var row = tableRows[i];
            var printRow = document.createElement('tr');

            // For each cell in the row (except the last one with actions)
            for (var j = 0; j < row.cells.length - 1; j++) {
                var cell = document.createElement('td');
                cell.style.border = '1px solid #ddd';
                cell.style.padding = '8px';
                cell.textContent = row.cells[j].textContent.trim();
                printRow.appendChild(cell);
            }

            printTbody.appendChild(printRow);
        }

        // Set the current date and time
        document.getElementById('print-date').textContent = new Date().toLocaleString();

        // Trigger print dialog
        window.print();
    }
</script>
</body>
</html>